name: 'Auto Update EPG'

on:
  schedule:
    - cron: '0 5,17 * * *'  # UTC 5ç‚¹å’Œ17ç‚¹ = åŒ—äº¬æ—¶é—´13ç‚¹å’Œ1ç‚¹
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          pip install pipenv
          pipenv install --deploy
          echo "ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: Debug - List files before generation
        run: |
          echo "=== ç”Ÿæˆå‰çš„æ–‡ä»¶ç»“æ„ ==="
          find . -type f -name "*.py" | head -20
          echo "=== Pipfileå†…å®¹ ==="
          cat Pipfile || echo "æ²¡æœ‰Pipfile"
      
      - name: Generate EPG with detailed logging
        run: |
          echo "=== å¼€å§‹ç”ŸæˆEPG ==="
          # åˆ é™¤æ—§çš„è¾“å‡ºæ–‡ä»¶
          rm -f output/epg.xml output/epg.gz 2>/dev/null || true
          
          # è¿è¡ŒEPGç”Ÿæˆå¹¶æ•è·è¾“å‡º
          echo "è¿è¡Œå‘½ä»¤: pipenv run epg"
          set -x  # å¼€å¯è¯¦ç»†è¾“å‡º
          pipenv run epg 2>&1 | tee epg_output.log
          set +x
          
          echo "=== EPGç”Ÿæˆè¾“å‡º ==="
          cat epg_output.log || echo "æ— è¾“å‡ºæ—¥å¿—"
      
      - name: Verify EPG content
        run: |
          echo "=== éªŒè¯EPGæ–‡ä»¶ ==="
          echo "è¾“å‡ºç›®å½•å†…å®¹ï¼š"
          ls -la output/ 2>/dev/null || echo "outputç›®å½•ä¸å­˜åœ¨"
          
          if [[ -f "output/epg.xml" ]]; then
            echo "EPGæ–‡ä»¶å¤§å°: $(du -h output/epg.xml)"
            echo "è¡Œæ•°: $(wc -l < output/epg.xml)"
            
            echo "=== é¢‘é“æ•°é‡ ==="
            channels=$(grep -c '<channel ' output/epg.xml)
            echo "$channels"
            
            echo "=== èŠ‚ç›®æ•°é‡ ==="
            programmes=$(grep -c '<programme ' output/epg.xml)
            echo "$programmes"
            
            if [[ $programmes -eq 0 ]]; then
              echo "âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰èŠ‚ç›®æ•°æ®ï¼"
              echo "å¯èƒ½çš„é—®é¢˜ï¼š"
              echo "1. æ•°æ®æºAPIå¤±æ•ˆ"
              echo "2. ç½‘ç»œè¯·æ±‚å¤±è´¥"
              echo "3. è§£æç¨‹åºé”™è¯¯"
              echo "=== æ–‡ä»¶å‰50è¡Œ ==="
              head -50 output/epg.xml
            else
              echo "âœ“ ç”ŸæˆæˆåŠŸï¼š$channels ä¸ªé¢‘é“ï¼Œ$programmes ä¸ªèŠ‚ç›®"
            fi
            
            # åˆ›å»ºå‹ç¼©æ–‡ä»¶
            gzip -c output/epg.xml > output/epg.gz
            echo "å‹ç¼©æ–‡ä»¶å¤§å°: $(du -h output/epg.gz)"
          else
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆepg.xml"
            find . -name "*.xml" -type f
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰è¾“å‡ºæ–‡ä»¶
          git add output/
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æ›´æ–°"
          else
            git commit -m "ğŸ“º EPGè‡ªåŠ¨æ›´æ–° - $(date +'%Y-%m-%d %H:%M:%S')"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          fi
