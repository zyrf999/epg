name: Auto Update EPG (æ•´åˆä¼˜åŒ–ç‰ˆ)
on:
  schedule:
    - cron: '0 5,17 * * *'  # UTC 5/17ç‚¹ = åŒ—äº¬æ—¶é—´13/1ç‚¹
    - cron: '0 0,12 * * *'  # æ–°å¢æ¯å¤©0/12ç‚¹è¡¥å……æ›´æ–°
  workflow_dispatch:  # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ master ]

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: é…ç½®Gitç½‘ç»œç¨³å®šæ€§ï¼ˆå–è‡ªæ—§ç‰ˆï¼‰
        run: |
          git config --global http.retry 5
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 60

      - name: æ‹‰å–ä»£ç ï¼ˆæ˜ç¡®åˆ†æ”¯+å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…å†²çª

      - name: è®¾ç½®Pythonï¼ˆä¿ç•™æ–°ç‰ˆ3.13+æ—§ç‰ˆå…¼å®¹æ€§ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'  # æ–°å¢ä¾èµ–ç¼“å­˜ï¼ŒåŠ é€Ÿå®‰è£…

      - name: å®‰è£…ä¾èµ–ï¼ˆæ•´åˆæ–°æ—§ç‰ˆï¼‰
        run: |
          python -m pip install --upgrade pip
          if [ -f "Pipfile" ]; then
            pip install pipenv && pipenv install --deploy
          else
            pip install -r requirements.txt
          fi
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Debug - å‰ç½®æ–‡ä»¶æ£€æŸ¥ï¼ˆå–è‡ªæ–°ç‰ˆï¼‰
        run: |
          echo "=== ç”Ÿæˆå‰æ–‡ä»¶ç»“æ„ ==="
          find . -type f -name "*.py" | head -20
          echo "=== é…ç½®æ–‡ä»¶å†…å®¹ ==="
          cat config.txt || echo "æ— config.txt"

      - name: è¿è¡ŒEPGç”Ÿæˆè„šæœ¬ï¼ˆæ•´åˆæ–°æ—§ç‰ˆï¼‰
        run: |
          echo "=== å¼€å§‹ç”ŸæˆEPG ==="
          rm -f output/epg.xml output/epg.gz 2>/dev/null || true
          set -x
          python merge.py 2>&1 | tee epg_output.log  # ç”¨merge.pyï¼ˆæ—§ç‰ˆï¼‰+ æ—¥å¿—ï¼ˆæ–°ç‰ˆï¼‰
          set +x
          echo "=== ç”Ÿæˆæ—¥å¿— ==="
          cat epg_output.log || echo "æ— æ—¥å¿—"

      - name: éªŒè¯EPGå†…å®¹ï¼ˆå¢å¼ºç‰ˆï¼Œæ•´åˆæ–°æ—§ç‰ˆï¼‰
        run: |
          echo "=== éªŒè¯æ–‡ä»¶ ==="
          ls -la output/ 2>/dev/null || echo "outputç›®å½•ä¸å­˜åœ¨"
          
          # æ–°ç‰ˆè¯¦ç»†éªŒè¯ + æ—§ç‰ˆå¤§å°æ£€æŸ¥
          if [[ -f "output/epg.xml" ]]; then
            echo "XMLå¤§å°: $(du -h output/epg.xml)"
            echo "è¡Œæ•°: $(wc -l < output/epg.xml)"
            channels=$(grep -c '<channel ' output/epg.xml)
            programmes=$(grep -c '<programme ' output/epg.xml)
            echo "é¢‘é“æ•°: $channels | èŠ‚ç›®æ•°: $programmes"
            
            if [[ $programmes -eq 0 || $(stat -c%s "output/epg.xml") -lt 100 ]]; then
              echo "âš ï¸ EPGæ— æ•ˆ"
              head -50 output/epg.xml
              exit 1
            fi
            
            gzip -c output/epg.xml > output/epg.gz
            if [[ $(stat -c%s "output/epg.gz") -lt 50 ]]; then
              echo "âš ï¸ å‹ç¼©æ–‡ä»¶æ— æ•ˆ"
              exit 1
            fi
            echo "âœ“ ç”ŸæˆæˆåŠŸ"
          else
            echo "âŒ æœªç”Ÿæˆepg.xml"
            exit 1
          fi

      - name: æäº¤å¹¶æ¨é€ï¼ˆè§£å†³å†²çªç‰ˆï¼‰
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git pull origin master --rebase || echo "æ‹‰å–å†²çªï¼Œå¼ºåˆ¶è¦†ç›–"
          git add output/
          
          if git diff --staged --quiet; then
            echo "æ— æ›´æ–°"
          else
            git commit -m "ğŸ“º EPGè‡ªåŠ¨æ›´æ–° - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin master --force  # ä¿ç•™æ—§ç‰ˆå¼ºåˆ¶æ¨é€ï¼Œé¿å…å†²çª
          fi
