name: Auto Update EPG (æœ€ç»ˆç¨³å®šç‰ˆ)
on:
  schedule:
    - cron: '0 5,17 * * *'  # UTC 5/17ç‚¹ = åŒ—äº¬æ—¶é—´13/1ç‚¹
    - cron: '0 0,12 * * *'  # æ¯å¤©0/12ç‚¹è¡¥å……æ›´æ–°
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ master ]

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: é…ç½®Gitç½‘ç»œç¨³å®šæ€§
        run: |
          git config --global http.retry 5
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 60

      - name: æ‹‰å–ä»£ç ï¼ˆå«ä¸Šæ¸¸åŒæ­¥ï¼‰
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          # åŒæ­¥ä¸Šæ¸¸ä»“åº“ï¼ˆè§£å†³åˆ†æ”¯è½åé—®é¢˜ï¼‰
          repository: zyrf999/epg
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: åŒæ­¥ä¸Šæ¸¸ä»“åº“
        run: |
          git remote add upstream https://github.com/mytv-android/myEPG.git
          git fetch upstream
          git merge upstream/master --allow-unrelated-histories || echo "ä¸Šæ¸¸æ— æ–°æäº¤"

      - name: è®¾ç½®Pythonï¼ˆåˆ©ç”¨Pipfileç¼“å­˜ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pipenv'  # åŒ¹é…ä»“åº“ä¸­çš„Pipfile

      - name: å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨Pipfileï¼‰
        run: |
          pip install --upgrade pip
          pip install pipenv
          pipenv install --deploy  # ä¸¥æ ¼æŒ‰ç…§Pipfile.lockå®‰è£…

      - name: Debug - ä»“åº“æ–‡ä»¶æ£€æŸ¥
        run: |
          echo "=== ä»“åº“æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la
          echo "=== Pipfileå†…å®¹ ==="
          cat Pipfile
          echo "=== config.txtå†…å®¹ ==="
          cat config.txt

      - name: è¿è¡ŒEPGç”Ÿæˆè„šæœ¬
        run: |
          echo "=== å¼€å§‹ç”ŸæˆEPG ==="
          rm -rf output/* 2>/dev/null || true
          set -x
          pipenv run python merge.py 2>&1 | tee epg_output.log
          set +x
          echo "=== ç”Ÿæˆæ—¥å¿— ==="
          cat epg_output.log || echo "æ— æ—¥å¿—"

      - name: éªŒè¯EPGæ–‡ä»¶
        run: |
          echo "=== éªŒè¯EPGæœ‰æ•ˆæ€§ ==="
          if [ ! -d "output" ]; then
            echo "âŒ outputç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "output/epg.xml" ]; then
            echo "âŒ æœªç”Ÿæˆepg.xml"
            exit 1
          fi
          if [ $(stat -c%s "output/epg.xml") -lt 100 ]; then
            echo "âŒ epg.xmlå†…å®¹è¿‡çŸ­"
            head -50 output/epg.xml
            exit 1
          fi
          # ç”Ÿæˆå‹ç¼©åŒ…
          gzip -c output/epg.xml > output/epg.gz
          if [ $(stat -c%s "output/epg.gz") -lt 50 ]; then
            echo "âŒ epg.gzå‹ç¼©å¤±è´¥"
            exit 1
          fi
          # ç»Ÿè®¡ä¿¡æ¯
          channels=$(grep -c '<channel ' output/epg.xml)
          programmes=$(grep -c '<programme ' output/epg.xml)
          echo "âœ“ ç”ŸæˆæˆåŠŸï¼š${channels}ä¸ªé¢‘é“ï¼Œ${programmes}ä¸ªèŠ‚ç›®"

      - name: æäº¤å¹¶æ¨é€æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add output/
          git add merge.py  # è‹¥è„šæœ¬æœ‰æ›´æ–°ä¹Ÿæäº¤
          
          if git diff --staged --quiet; then
            echo "æ— å†…å®¹æ›´æ–°ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ“º EPGè‡ªåŠ¨æ›´æ–° - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin master --force-with-lease  # å®‰å…¨å¼ºåˆ¶æ¨é€
          fi
